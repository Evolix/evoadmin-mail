---
- hosts: all
  gather_facts: yes
  become: yes

  vars:
    evolinux_hostname: "evoadmin-mail"
    evolinux_domain: "example.com"
    evolinux_fqdn: "{{ evolinux_hostname }}.{{ evolinux_domain }}"
    evomaintenance_alert_email: "evomaintenance-{{ evolinux_hostname }}@example.com"

  roles:
    - evolinux-base
    - { role: postfix, postfix_packmail: True, postfix_force_main_cf: True }
    - apache
    - { role: php, php_apache_enable: True }
    - { role: webapps/evoadmin-mail }

  tasks:
  - name: Disable redirection for evoadminmail vhost
    lineinfile:
      dest: /etc/apache2/sites-enabled/evoadminmail.conf
      regexp: "Rewrite"
      state: absent

  - name: Fix rights on /etc/evolinux
    file:
      dest: /etc/evolinux
      state: directory
      mode: "0711"

  - name: Link config.ini to evoadmin-mail.ini
    file:
      src: /etc/evolinux/evoadmin-mail.ini
      dest: /vagrant/config/config.ini
      state: link

  - name: Remove distant htdocs dir
    file:
      dest: /home/evoadmin-mail/www
      state: absent

  - name: Use local htdocs dir
    file:
      src: /vagrant
      dest: /home/evoadmin-mail/www
      state: link
      force: yes
